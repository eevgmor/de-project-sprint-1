# Витрина RFM

## 1.1. Выясните требования к целевой витрине.

Постановка задачи выглядит достаточно абстрактно - постройте витрину. Первым делом вам необходимо выяснить у заказчика детали. Запросите недостающую информацию у заказчика в чате.

Зафиксируйте выясненные требования. Составьте документацию готовящейся витрины на основе заданных вами вопросов, добавив все необходимые детали.

-----------

Задача — построить витрину для RFM-классификации. 

Для анализа нужно отобрать только успешно выполненные заказы. Это заказы со статусом Closed

Витрина должна располагаться в той же базе в схеме analysis, название витрины dm_rfm_segments

В витрине нужны данные с начала 2022 года.

Витрина должна состоять из таких полей:
- user_id
- recency (число от 1 до 5)
- frequency (число от 1 до 5)
- monetary_value (число от 1 до 5)


Так как в таблице users 1000 записей, то в каждую категорию должно получиться 200 пользователей.
При этом, если количество заказов одинаковое, то неважно, кого поставить выше, а кого ниже. Аналогично и с другими показателями.

Описание метрик:

- Фактор Recency измеряется по последнему заказу. Распределите клиентов по шкале от одного до пяти, где значение 1 получат те, кто либо вообще не делал заказов, либо делал их очень давно, а 5 — те, кто заказывал относительно недавно.

- Фактор Frequency оценивается по количеству заказов. Распределите клиентов по шкале от одного до пяти, где значение 1 получат клиенты с наименьшим количеством заказов, а 5 — с наибольшим.

- Фактор Monetary Value оценивается по потраченной сумме. Распределите клиентов по шкале от одного до пяти, где значение 1 получат клиенты с наименьшей суммой, а 5 — с наибольшей.

## 1.2. Изучите структуру исходных данных.

Подключитесь к базе данных и изучите структуру таблиц.

Если появились вопросы по устройству источника, задайте их в чате.

Зафиксируйте, какие поля вы будете использовать для расчета витрины.

-----------
Метрика Recency -  таблица users (id - как user_id пользователя), таблица orders(user_id, status - статус заказа 4, order_ts - время заказа)

Метрика Frequency - таблица users (id - как user_id пользователя), таблица orders(user_id, status - статус заказа 4, order_ts - время заказа)

Метрика Monetary Value - таблица users (id - как user_id пользователя), таблица orders(user_id, status - статус заказа 4, order_ts - время заказа, payment - потраченная сумма)



## 1.3. Проанализируйте качество данных

Изучите качество входных данных. Опишите, насколько качественные данные хранятся в источнике. Так же укажите, какие инструменты обеспечения качества данных были использованы в таблицах в схеме production.

-----------

Заполнен data_quality.md


## 1.4. Подготовьте витрину данных

Теперь, когда требования понятны, а исходные данные изучены, можно приступить к реализации.

### 1.4.1. Сделайте VIEW для таблиц из базы production.**

Вас просят при расчете витрины обращаться только к объектам из схемы analysis. Чтобы не дублировать данные (данные находятся в этой же базе), вы решаете сделать view. Таким образом, View будут находиться в схеме analysis и вычитывать данные из схемы production. 

Напишите SQL-запросы для создания пяти VIEW (по одному на каждую таблицу) и выполните их. Для проверки предоставьте код создания VIEW.

```SQL
CREATE VIEW analysis.orderitems AS (SELECT * FROM production.orderitems);
CREATE VIEW analysis.orders AS (SELECT * FROM production.orders);
CREATE VIEW analysis.orderstatuses AS (SELECT * FROM production.orderstatuses);
CREATE VIEW analysis.orderstatuslog AS (SELECT * FROM production.orderstatuslog);
CREATE VIEW analysis.products AS (SELECT * FROM production.products);
CREATE VIEW analysis.users AS (SELECT * FROM production.users);
```

### 1.4.2. Напишите DDL-запрос для создания витрины.**

Далее вам необходимо создать витрину. Напишите CREATE TABLE запрос и выполните его на предоставленной базе данных в схеме analysis.

```SQL
CREATE TABLE analysis.dm_rfm_segments (
	user_id int4 NOT NULL,
	recency int NOT NULL,
	frequency int NOT NULL,
	monetary_value int NOT null,
	CONSTRAINT dm_rfm_segments_pkey PRIMARY KEY(user_id)
);
```

### 1.4.3. Напишите SQL запрос для заполнения витрины

Наконец, реализуйте расчет витрины на языке SQL и заполните таблицу, созданную в предыдущем пункте.

Для решения предоставьте код запроса.

```SQL
insert into analysisdm_rfm_segments
select 
	u.id as user_id,
	recency,
	frequency,
	monetary_value
from analysis.users u
join analysis.tmp_rfm_recency trr on u.id = trr.user_id
join analysis.tmp_rfm_frequency trf on u.id = trf.user_id
join analysis.tmp_rfm_monetary_value trmv on u.id = trmv.user_id
order by user_id asc;

user_id|recency|frequency|monetary_value|
-------+-------+---------+--------------+
      0|      5|        3|             4|
      1|      2|        3|             3|
      2|      4|        3|             5|
      3|      4|        3|             3|
      4|      3|        3|             3|
      5|      2|        5|             5|
      6|      5|        3|             5|
      7|      2|        2|             2|
      8|      5|        2|             3|
      9|      5|        2|             2|

```



